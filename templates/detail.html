{% extends "layout.html" %}

{% block title %}{{ ticker.symbol }} - Stock Selector{% endblock %}

{% block content %}
<div class="mb-6 bg-white p-6 rounded-lg shadow-sm border">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">{{ ticker.symbol }} - {{ ticker.name }}</h1>
            <p class="text-gray-500">{{ ticker.sector or 'Unknown sector' }}</p>
        </div>
        <div class="text-right">
            {% if synthesis %}
            <div class="text-3xl font-bold {% if synthesis.overall_score >= 3 %}text-green-600{% elif synthesis.overall_score <= -3 %}text-red-600{% else %}text-yellow-600{% endif %}">
                {{ "%.1f"|format(synthesis.overall_score) }}
            </div>
            <span class="px-3 py-1 rounded text-sm font-bold uppercase badge-{{ synthesis.recommendation }}">
                {{ synthesis.recommendation }}
            </span>
            {% else %}
            <span class="text-gray-400">Not analyzed yet</span>
            {% endif %}
        </div>
    </div>
    <div class="mt-4 flex gap-3">
        <button onclick="refreshTicker('{{ ticker.symbol }}')"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
            Refresh Analysis
        </button>
        <form action="/tickers/{{ ticker.symbol }}/delete" method="post" class="inline"
              onsubmit="return confirm('Remove {{ ticker.symbol }}?')">
            <button type="submit" class="px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 text-sm">
                Remove from Watchlist
            </button>
        </form>
        <a href="/" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">
            Back to Dashboard
        </a>
    </div>
    <div id="progress" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <span class="text-blue-800">Analyzing: </span>
        <span id="step" class="text-blue-700 font-medium">Starting...</span>
    </div>
</div>

{% if synthesis %}
<div class="mb-6 bg-white p-6 rounded-lg shadow-sm border">
    <h2 class="text-lg font-semibold mb-4">Signal Breakdown</h2>
    <canvas id="scoreChart" height="80"></canvas>
</div>

<div class="mb-6 bg-white p-6 rounded-lg shadow-sm border">
    <h2 class="text-lg font-semibold mb-3">Overall Analysis</h2>
    <div class="prose max-w-none text-gray-700">{{ synthesis.narrative | markdown }}</div>
</div>


{% for analysis in analyses %}
<details class="mb-3 bg-white rounded-lg shadow-sm border">
    <summary class="px-6 py-4 cursor-pointer flex items-center justify-between">
        <span class="font-medium capitalize">{{ analysis.category | replace("_", " ") }}</span>
        <div class="flex items-center gap-3">
            <span class="text-sm px-2 py-0.5 rounded bg-gray-100">{{ analysis.confidence }}</span>
            <span class="font-bold {% if analysis.score >= 3 %}text-green-600{% elif analysis.score <= -3 %}text-red-600{% else %}text-yellow-600{% endif %}">
                {{ "%.1f"|format(analysis.score) }}
            </span>
        </div>
    </summary>
    <div class="px-6 pb-4 border-t">
        <div class="prose max-w-none text-gray-700 mt-3">{{ analysis.narrative | markdown }}</div>
        <details class="mt-3">
            <summary class="text-sm text-gray-500 cursor-pointer">Raw scraped data</summary>
            <pre class="mt-2 p-3 bg-gray-50 rounded text-xs overflow-x-auto">{{ analysis.raw_data }}</pre>
        </details>
    </div>
</details>
{% endfor %}

{% if history | length > 1 %}
<div class="mb-6 bg-white p-6 rounded-lg shadow-sm border">
    <h2 class="text-lg font-semibold mb-4">Score History</h2>
    <canvas id="historyChart" height="60"></canvas>
</div>
{% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
{% if signal_scores %}
<script>
const scores = {{ signal_scores | tojson }};
const labels = Object.keys(scores).map(k => k.replace(/_/g, ' '));
const values = Object.values(scores);
const colors = values.map(v => v >= 3 ? '#10b981' : v <= -3 ? '#ef4444' : '#f59e0b');

new Chart(document.getElementById('scoreChart'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            data: values,
            backgroundColor: colors,
            borderRadius: 4,
        }]
    },
    options: {
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: {
            x: { min: -10, max: 10, grid: { color: '#f3f4f6' } },
            y: { grid: { display: false } }
        }
    }
});
</script>
{% endif %}

{% if history and history | length > 1 %}
<script>
const historyData = {{ history | tojson }};
new Chart(document.getElementById('historyChart'), {
    type: 'line',
    data: {
        labels: historyData.map(h => h.created_at).reverse(),
        datasets: [{
            label: 'Overall Score',
            data: historyData.map(h => h.overall_score).reverse(),
            borderColor: '#3b82f6',
            tension: 0.3,
            fill: false,
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { min: -10, max: 10 },
        }
    }
});
</script>
{% endif %}
{% endblock %}
