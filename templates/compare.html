{% extends "layout.html" %}

{% block title %}Compare Tickers - Stock Selector{% endblock %}

{% block content %}
<div class="mb-6 bg-white dark:bg-slate-900 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800">
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Compare Tickers</h1>
    <form method="get" action="/compare" class="flex flex-wrap gap-3 items-end" id="compare-form">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-slate-200 mb-1">Select 2-3 tickers to compare</label>
            <div class="flex gap-2 flex-wrap">
                {% for t in all_tickers %}
                <label class="inline-flex items-center gap-1.5 px-3 py-1.5 border rounded-md text-sm cursor-pointer transition
                    {% if t.symbol in selected_symbols %}bg-blue-100 border-blue-400 text-blue-800 dark:bg-blue-900/40 dark:border-blue-500 dark:text-blue-200{% else %}bg-white border-slate-300 text-slate-700 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-700{% endif %}">
                    <input type="checkbox" class="compare-cb hidden" value="{{ t.symbol }}"
                           {% if t.symbol in selected_symbols %}checked{% endif %}
                           {% if t.overall_score is none %}disabled{% endif %}>
                    <span>{{ t.symbol }}</span>
                    {% if t.overall_score is none %}
                    <span class="text-xs text-gray-400 dark:text-slate-500">(no data)</span>
                    {% endif %}
                </label>
                {% endfor %}
            </div>
        </div>
        <input type="hidden" name="symbols" id="symbols-input">
        <button type="submit" id="compare-btn" disabled
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm shadow-sm disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-blue-500/60">
            Compare
        </button>
    </form>
    {% if selected_symbols and (selected_symbols | length < 2 or selected_symbols | length > 3) %}
    <p class="mt-2 text-sm text-red-600 dark:text-red-400">Please select 2 or 3 tickers to compare.</p>
    {% endif %}
</div>

{% if comparison %}
<!-- Overall Scores -->
<div class="mb-6 bg-white dark:bg-slate-900 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800">
    <h2 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Overall Scores</h2>
    <div class="grid grid-cols-{{ comparison | length }} gap-4">
        {% for t in comparison %}
        <div class="text-center p-4 rounded-lg border border-slate-200 dark:border-slate-700">
            <a href="/ticker/{{ t.symbol }}" class="text-lg font-bold text-blue-600 dark:text-blue-400 hover:underline">{{ t.symbol }}</a>
            <p class="text-sm text-gray-500 dark:text-slate-400">{{ t.name }}</p>
            <p class="text-xs text-gray-400 dark:text-slate-500 mb-2">{{ t.sector or '-' }}</p>
            {% if t.overall_score is not none %}
            <div class="text-3xl font-bold {% if t.overall_score >= 3 %}text-green-500 dark:text-green-400{% elif t.overall_score <= -3 %}text-red-500 dark:text-red-400{% else %}text-yellow-500 dark:text-yellow-400{% endif %}">
                {{ "%.1f"|format(t.overall_score) }}
            </div>
            <span class="px-2 py-1 rounded text-xs font-bold uppercase badge-{{ t.recommendation }}">
                {{ t.recommendation }}
            </span>
            {% else %}
            <span class="text-gray-400 dark:text-slate-500">Not analyzed</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Category Score Comparison Table -->
{% if categories %}
<div class="mb-6 bg-white dark:bg-slate-900 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800">
    <h2 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Category Breakdown</h2>
    <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-slate-900/60">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-slate-400">Category</th>
                {% for t in comparison %}
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase dark:text-slate-400">{{ t.symbol }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
            {% for cat in categories %}
            <tr class="hover:bg-gray-50 dark:hover:bg-slate-800/60">
                <td class="px-4 py-3 font-medium capitalize text-slate-700 dark:text-slate-200">{{ cat | replace("_", " ") }}</td>
                {% for t in comparison %}
                {% set score = t.parsed_scores.get(cat) %}
                <td class="px-4 py-3 text-center font-bold {% if score is not none %}{% if score >= 3 %}text-green-500 dark:text-green-400{% elif score <= -3 %}text-red-500 dark:text-red-400{% else %}text-yellow-500 dark:text-yellow-400{% endif %}{% else %}text-gray-400 dark:text-slate-500{% endif %}">
                    {% if score is not none %}{{ "%.1f"|format(score) }}{% else %}-{% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
            <tr class="bg-gray-50 dark:bg-slate-800/40 font-bold">
                <td class="px-4 py-3 text-slate-700 dark:text-slate-200">Overall</td>
                {% for t in comparison %}
                <td class="px-4 py-3 text-center {% if t.overall_score is not none %}{% if t.overall_score >= 3 %}text-green-500 dark:text-green-400{% elif t.overall_score <= -3 %}text-red-500 dark:text-red-400{% else %}text-yellow-500 dark:text-yellow-400{% endif %}{% else %}text-gray-400{% endif %}">
                    {% if t.overall_score is not none %}{{ "%.1f"|format(t.overall_score) }}{% else %}-{% endif %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
</div>

<!-- Radar Chart -->
<div class="mb-6 bg-white dark:bg-slate-900 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800">
    <h2 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Radar Comparison</h2>
    <div class="max-w-lg mx-auto">
        <canvas id="radarChart"></canvas>
    </div>
</div>
{% endif %}
{% endif %}

<div class="mt-4">
    <a href="/" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
        Back to Dashboard
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// Ticker selection logic
(function() {
    const checkboxes = document.querySelectorAll('.compare-cb');
    const symbolsInput = document.getElementById('symbols-input');
    const compareBtn = document.getElementById('compare-btn');

    function updateState() {
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        const count = checked.length;

        // Enable/disable unchecked boxes when 3 are selected
        checkboxes.forEach(cb => {
            if (!cb.checked && !cb.disabled) {
                cb.parentElement.classList.toggle('opacity-50', count >= 3);
                cb.disabled = count >= 3;
            }
        });

        // Re-enable disabled-by-limit boxes if under 3
        if (count < 3) {
            checkboxes.forEach(cb => {
                // Only re-enable if it was disabled by limit, not by "no data"
                if (cb.disabled && !cb.parentElement.querySelector('.text-gray-400, .dark\\:text-slate-500')) {
                    cb.disabled = false;
                    cb.parentElement.classList.remove('opacity-50');
                }
            });
        }

        // Toggle visual state
        checkboxes.forEach(cb => {
            const label = cb.parentElement;
            if (cb.checked) {
                label.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-800', 'dark:bg-blue-900/40', 'dark:border-blue-500', 'dark:text-blue-200');
                label.classList.remove('bg-white', 'border-slate-300', 'text-slate-700', 'dark:bg-slate-800', 'dark:border-slate-600', 'dark:text-slate-200');
            } else if (!cb.disabled) {
                label.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-800', 'dark:bg-blue-900/40', 'dark:border-blue-500', 'dark:text-blue-200');
                label.classList.add('bg-white', 'border-slate-300', 'text-slate-700', 'dark:bg-slate-800', 'dark:border-slate-600', 'dark:text-slate-200');
            }
        });

        compareBtn.disabled = count < 2;
        symbolsInput.value = checked.map(cb => cb.value).join(',');
    }

    checkboxes.forEach(cb => cb.addEventListener('change', updateState));
    updateState();
})();
</script>

{% if comparison and categories %}
<script>
// Radar chart
const radarLabels = {{ categories | tojson }};
const chartColors = ['#3b82f6', '#ef4444', '#10b981'];
const bgColors = ['rgba(59,130,246,0.15)', 'rgba(239,68,68,0.15)', 'rgba(16,185,129,0.15)'];

const datasets = [
{% for t in comparison %}
    {
        label: '{{ t.symbol }}',
        data: radarLabels.map(cat => {
            const scores = {{ t.parsed_scores | tojson }};
            const val = scores[cat];
            return val !== undefined ? (val + 10) / 20 * 10 : 0;
        }),
        borderColor: chartColors[{{ loop.index0 }}],
        backgroundColor: bgColors[{{ loop.index0 }}],
        pointBackgroundColor: chartColors[{{ loop.index0 }}],
    },
{% endfor %}
];

new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
        labels: radarLabels.map(l => l.replace(/_/g, ' ')),
        datasets: datasets,
    },
    options: {
        scales: {
            r: {
                min: 0,
                max: 10,
                ticks: {
                    display: false,
                },
                pointLabels: {
                    font: { size: 11 },
                },
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(ctx) {
                        // Convert back from 0-10 scale to -10..+10
                        const actual = (ctx.raw / 10 * 20) - 10;
                        return ctx.dataset.label + ': ' + actual.toFixed(1);
                    }
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
